# 백업 쉘스크립트

- 웹, 디비, 서버에 문제가 발생했을 때 데이터 복구할 수 있도록 중요한 데이터를 다른 곳에 보관

- tar(Tape ARchiver) 

  - [더 자세한 설명](./명령어 모음/tar.md)

  - 여러 파일을 하나의 파일로 묶음

    - 압축(`gzip`)은 명령어 옵션으로 실행

  - 파일 압축: 

    `tar -czvf {압축 파일명}.tar.gz {압축할 파일1} {압축할 파일2} ...` 

  - 디렉토리 압축:
  
    `tar -czvf {압축 파일명}.tar.gz {압축할 디렉토리}`
  
  - 압축 풀기
  
    - `tar.gz` 압축 풀기: `tar -xzvf {압축 파일명}.tar.gz `
    - `tar` 압축 풀기: `tar -xvf {압축 파일명}.tar`



- mariabackup

  - 마리아디비를 백업할 유틸리티

    - cent1: web 서버, cent2: DB 서버, cent3: 스토리지 서버

      `vagrant ssh cent2` 후 사용하기

  - 온라인 백업할 때 락이 걸리면 안됌

    - user들은 계속 사용하고 있으니깐

  - #### mariabackup  명령어 

  - ```sh
    mariabackup \
    --backup \
    --no-lock \
    --target-dir=백업 파일을 저장할 수 있는 디렉토리
    ## 로컬에서 백업할 거여서 아래는 설정하지 않아도 됨
    --host=백업할 호스트 아이피 \
    --port=
    --user=유저명 \
    --password=비밀번호
    
    
    ## 백업하는 동안 수정되는 트랜잭션들은 ib_logfile0에 쌓이는데 이 디렉토리도 백업파일에 포함해야함
    mariabackup \
    --prepare \
    --target-dir=위에서 지정한 백업 디렉토리 패스
    
    ## 복구
    mariabackup \
    --move-back \ ## copy-back도 같은 명령어
    --target-dir=위에서 지정한 백업 디렉토리 패스 \
    --data-dir=복구할 디렉토리 패스
    ```



#### 작업 흐름

| 정책   | 내용                                                         | 방법                                                         |
| ------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 무엇을 | - 웹: 웹소스, 서버 주요 설정<br />- DB: 데이터, 서버 주요 설정<br />- 스토리지: 서버 주요 설정 | - tar불로 묶어서 보관<br />- DB 덤프는 마리아디비 전용 백업툴인 mariabackup을 사용<br />- 스토리지는 데이터 용량이 크기 때문에<br />향후 스토리지 이중화 등을 통해 데이터 안정성 확보<br />(이번에 스토리지 백업하지 않을 것임) |
| 언제   | - 하루 한 번 트래픽이 가장 적은 시간 대                      | - ex) 새벽 3-5시                                             |
| 어디에 | - 스토리지의 BACKUP 디렉토리<br /> : 각 서버 이름(hostname) 디렉토리 | - `/mnt/BACKUP/서버호스트이름`                               |



### 백업 스크립트가 해야 할 일 정리

- 스토리지에 마운트 mount
- 지정한 파일/디렉토리를 tar불로 묶어서 저장
  - 디비 서버의 경우 데이터 덤프 후 tar불로 묶어서 저장 mariadbbackup
- 백업 레포팅파일 생성 echo, reflect
  - 백업 시작/종료 시각 date
  - 백업 파일 정보 ls
- 레포팅 파일을 읽어 관리자 텔레그램으로 전송 /vagrant/SHELL/bot.sh

#### 백업 스크립트

`web_backup.sh`

```sh
#!/bin/bash
## 변수 설정, 
## HOST =${hostname}으로 할 시 크론탭이 hostname 못 읽을 수 있어 hostname 파일이 있는 절대 경로의 path로 지정해야함

## 왜 모든 변수에 ${} 안 하지?
HOST="$(/usr/bin/hostname)"
LOG="/tmp/backup.log"
PUSH="/vagrant/SHELL/monitor/bot.sh"
DATE="$(/bin/date +%Y.%m.%d)" ## 년.월.일
## 백업할 디렉토리/파일 지정
BAK_LIST="/etc/nginx /usr/share/nginx/html/www"
## 백업 디렉토리
BAK_PATH="/mnt/BACKUP/${HOST}"
## 백업 파일명
BAK_FILE="${BAK_PATH}/${DATE}_${HOST}.tgz"

## 스토리지에 마운트, 필요할 때마다 접속해서 마운트&언마운트 하기
/usr/bin/mount /mnt

## 로그 파일 생성
/usr/bin/touch "${LOG}"

## 백업 디렉토리 확인 (없으면 에러 날 수 있으니 에러 예방)
if [ -e "${BAK_PATH}" ]
then
	## 백업 디렉토리 존재
	/bin/echo "백업 디렉토리 있습니다. 문제 없음."
else
	## 백업 디렉토리 없으니 생성
	/usr/bin/mkdir -p "${BAK_PATH}"
fi

## ****** 로그 기록 시작 - 중과호 안의 내용이 LOG 파일로 저장
{	
	## 백업 시작 시각
	/bin/echo
	/bin/echo "=== 백업 시작 시각: "
	/bin/date
	/bin/echo
    
	## 백업✨✨✨
	/usr/bin/tar czpPf "${BAK_FILE}" ${BAK_LIST}
	
	## 백업 파일 정보
	NAME="$(/usr/bin/ls -al "${BAK_FILE}" | awk '{print $9}')"
	SIZE="$(/usr/bin/ls -al "${BAK_FILE}" | awk '{print $5}')"
	/bin/echo "=== 백업 파일 정보 :"
	/bin/echo " | 파일명: ${NAME}"
	/bin/echo " | 파일크기: ${SIZE}Byte" ## ls로 출력할 때 byte로 뜸
	/bin/echo
	
	## 백업 종료 시각
	/bin/echo
	/bin/echo "=== 백업 종료 시각: "
	/bin/date
	/bin/echo

} >|"${LOG}"
## ***** 로그 기록 끝

## 스토리지에 언마운트
/usr/bin/umount /mnt

## 텔레그램으로 백업 로그를 전송
"${PUSH}" "${HOST}" "$(/usr/bin/cat "${LOG}")"

## 로그 파일 삭제
/usr/bin/rm -f "${LOG}"
```

- `whitch 명령어`: 명령어가 있는 bin 디렉토리의 절대경로 출력

- `find -name bot.sh`: 파일/디렉토리 찾을 때

- `ps -ef`: 실행 중인 프로세스를 모두 출력

  ```sh
  # ps -ef|grep nginx
  root         629       1  0 Dec02 ?        00:00:00 nginx: master process /usr/sbin/nginx
  nginx        630     629  0 Dec02 ?        00:00:00 nginx: worker process
  nginx        631     629  0 Dec02 ?        00:00:00 nginx: worker process
  root        2412    2376  0 02:34 pts/0    00:00:00 grep --color=auto nginx
  ```

- 백업 디렉토리 

  백업할 파일/디렉토리 지정

  ```sh
  BAK_LIST="/etc/nginx /usr/share/nginx/html/www"
  ```

  - 두 개의 파일을 압축할 것
  - `/etc/nginx`: 서버 nginx 설정 파일
  - `/usr/share/nginx/html/www`: 웹사이트를 구성하는 소스 파일

  ```sh
  ## nginx 설정 파일
  # cd /ect/nginx/conf.d 
  # cat default.conf
  server {
      listen       80;
      server_name  vws.tmpcompany.com;
  
      access_log  /var/log/nginx/VWS.access.log  main;
  
      location / {
          root   /usr/share/nginx/html/www; ## ✨ 홈페이지를 이루는 소스이자 백업할 파일
          index  index.html index.htm;
      }
  }
  ```

- 스토리지에 마운트

  ```sh
  /usr/bin/mount /mnt
  ```

  - `/mnt`: 사용자가 직접 커맨드라인을 통해 마운트할 때 사용되는 디렉토리
  - `/media`: USB, CD-ROM등의 장치가 연결될 때 OS가 자동으로 마운트하는 디렉토리

- 로그 파일 생성

  ```sh
  /usr/bin/touch "${LOG}"
  ```

  - `touch` 

    - 파일/디렉토리가 있을 시:

       업데이트 일자를 현재 시간으로 변경

    - 없을 시:

      빈 파일 생성

- 백업 디렉토리 확인

  - `mkdir -p "${BAK_PATH}"`: 

    백업 디렉토리가 없다면 `BAK_PATH="/mnt/BACKUP/${HOST}"`가 없다는 뜻이므로 /mnt 하위 폴더인 BACKUP이 없는 상태인데

    `mkdir -p` (p: parent) 명령어는  `${HOST}`의 부모 디렉토리인 `/BACKUP` 까지 함께 만들어줘서 에러 방지

- 백업

  - `{BAK_FILE}`: `{BAK_LIST}`를 압축한 파일 

  - ```sh
    ## 백업
    /usr/bin/tar czpPf "${BAK_FILE}" ${BAK_LIST}
    ```

    - `p`: 퍼미션(권한) 유지
    - `P`: 절대 경로 유지
    - `f`: 다음에 파일명 오기
    - `${BAK_LIST}`: "" 쌍따움표 하면 중복

- 백업 파일 정보

  ```sh
  NAME="$(/usr/bin/ls -al) "${BAK_FILE}" | awk '{print $9}')"
  
  SIZE="$(/usr/bin/ls -al) "${BAK_FILE}" | awk '{print $5}')"
  ```

  - ls와 awk 이용해서 이름과 사이즈 출력

    ```sh
    # ls -al log_monitor
    -rwx------ 1 root root 641 Dec  3 00:02 log_monitor
    
    ## 공백을 기준으로 숫자 증가
    [root@cent1 monitor]# ls -al log_monitor | awk '{print $1}'
    -rwx------
    
    [root@cent1 monitor]# ls -al log_monitor | awk '{print $5}'
    641
    
    [root@cent1 monitor]# ls -al log_monitor | awk '{print $9}'
    log_monitor
    ```

  - `ls -l {파일 이름}`: 파일 이름 출력하는 또다른 방법

    ```sh
    # ls -1 log_monitor.sh
    log_monitor.sh
    ```

    

#### 백업 스크립트 쉘 출력

```sh
# chmod 700 web_backup.sh
# ./web_backup.sh
백업 디렉토리 있습니다. 문제 없음.
```

<p align = "center"><img src="사진 폴더/telegram_bot_backup2.png"></img></p>



#### 크론탭에 백업 스크립트 저장

```sh
crontab -e

## 웹서버 백업
## 새벽 4시마다 백업
00 04 * * * /root/vagrant/SHELL/BACKUP/web_backup.sh >/dev/null 2>&1
```

#### 크론탭에서 로그 확인하기

- log 잘 쌓이는 지 확인을 위해 매분마다로 변경

  `*/1 * * * *`

```sh
Dec  3 07:42:01 cent1 CROND[3053]: (root) CMD (/root/vagrant/SHELL/BACKUP/web_backup.sh >/dev/null 2>&1)
Dec  3 07:43:01 cent1 CROND[3080]: (root) CMD (/root/vagrant/SHELL/BACKUP/web_backup.sh >/dev/null 2>&1)
```

- 잘 작동되는 거 확인^____^

