# 백업 쉘스크립트

- 웹, 디비, 서버에 문제가 발생했을 때 데이터 복구할 수 있도록 중요한 데이터를 다른 곳에 보관

- tar

  - tar -cvzf [압축할 파일/디렉토리] 

  - tar xvzf[압축파일명]

    -c: create

    -v: 버보스..?출력

    z: zip

    f: 파일



- mariabackup

  - 마리아디비를 백업할 유틸리티

    - cent1: web 서버, cent2: DB 서버, cent3: 스토리지 서버

      `vagrant ssh cent2` 후 사용하기

  - 온라인 백업할 때 락이 걸리면 안됌

    - user들은 계속 사용하고 있으니깐

  - #### mariabackup  명령어 

  - ```sh
    mariabackup \
    --backup \
    --no-lock \
    --target-dir=백업 파일을 저장할 수 있는 디렉토리
    ## 로컬에서 백업할 거여서 아래는 설정하지 않아도 됨
    --host=백업할 호스트 아이피 \
    --port=
    --user=유저명 \
    --password=비밀번호
    
    
    ## 백업하는 동안 수정되는 트랜잭션들은 ib_logfile0에 쌓이는데 이 디렉토리도 백업파일에 포함해야함
    mariabackup \
    --prepare \
    --target-dir=위에서 지정한 백업 디렉토리 패스
    
    ## 복구
    mariabackup \
    --move-back \ ## copy-back도 같은 명령어
    --target-dir=위에서 지정한 백업 디렉토리 패스 \
    --data-dir=복구할 디렉토리 패스
    ```



#### 작업 흐름

| 정책   | 내용                                                         | 방법                                                         |
| ------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 무엇을 | - 웹: 웹소스, 서버 주요 설정<br />- DB: 데이터, 서버 주요 설정<br />- 스토리지: 서버 주요 설정 | - tar불로 묶어서 보관<br />- DB 덤프는 마리아디비 전용 백업툴인 mariabackup을 사용<br />- 스토리지는 데이터 용량이 크기 때문에<br />향후 스토리지 이중화 등을 통해 데이터 안정성 확보<br />(이번에 스토리지 백업하지 않을 것임) |
| 언제   | - 하루 한 번 트래픽이 가장 적은 시간 대                      | - ex) 새벽 3-5시                                             |
| 어디에 | - 스토리지의 BACKUP 디렉토리<br /> : 각 서버 이름(hostname) 디렉토리 | - `/mnt/BACKUP/서버호스트이름`                               |

