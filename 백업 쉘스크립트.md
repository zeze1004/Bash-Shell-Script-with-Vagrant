# 백업 쉘스크립트

- 웹, 디비, 서버에 문제가 발생했을 때 데이터 복구할 수 있도록 중요한 데이터를 다른 곳에 보관

- tar

  - tar -cvzf [압축할 파일/디렉토리] 

  - tar xvzf[압축파일명]

    -c: create

    -v: 버보스..?출력

    z: zip

    f: 파일



- mariabackup

  - 마리아디비를 백업할 유틸리티

    - cent1: web 서버, cent2: DB 서버, cent3: 스토리지 서버

      `vagrant ssh cent2` 후 사용하기

  - 온라인 백업할 때 락이 걸리면 안됌

    - user들은 계속 사용하고 있으니깐

  - #### mariabackup  명령어 

  - ```sh
    mariabackup \
    --backup \
    --no-lock \
    --target-dir=백업 파일을 저장할 수 있는 디렉토리
    ## 로컬에서 백업할 거여서 아래는 설정하지 않아도 됨
    --host=백업할 호스트 아이피 \
    --port=
    --user=유저명 \
    --password=비밀번호
    
    
    ## 백업하는 동안 수정되는 트랜잭션들은 ib_logfile0에 쌓이는데 이 디렉토리도 백업파일에 포함해야함
    mariabackup \
    --prepare \
    --target-dir=위에서 지정한 백업 디렉토리 패스
    
    ## 복구
    mariabackup \
    --move-back \ ## copy-back도 같은 명령어
    --target-dir=위에서 지정한 백업 디렉토리 패스 \
    --data-dir=복구할 디렉토리 패스
    ```



#### 작업 흐름

| 정책   | 내용                                                         | 방법                                                         |
| ------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 무엇을 | - 웹: 웹소스, 서버 주요 설정<br />- DB: 데이터, 서버 주요 설정<br />- 스토리지: 서버 주요 설정 | - tar불로 묶어서 보관<br />- DB 덤프는 마리아디비 전용 백업툴인 mariabackup을 사용<br />- 스토리지는 데이터 용량이 크기 때문에<br />향후 스토리지 이중화 등을 통해 데이터 안정성 확보<br />(이번에 스토리지 백업하지 않을 것임) |
| 언제   | - 하루 한 번 트래픽이 가장 적은 시간 대                      | - ex) 새벽 3-5시                                             |
| 어디에 | - 스토리지의 BACKUP 디렉토리<br /> : 각 서버 이름(hostname) 디렉토리 | - `/mnt/BACKUP/서버호스트이름`                               |



### 백업 스크립트가 해야 할 일 정리

- 스토리지에 마운트 mount
- 지정한 파일/디렉토리를 tar불로 묶어서 저장
  - 디비 서버의 경우 데이터 덤프 후 tar불로 묶어서 저장 mariadbbackup
- 백업 레포팅파일 생성 echo, reflect
  - 백업 시작/종료 시각 date
  - 백업 파일 정보 ls
- 레포팅 파일을 읽어 관리자 텔레그램으로 전송 /vagrant/SHELL/bot.sh

```sh
#!/bin/bash
## 변수 설정, 
## HOST =${hostname}으로 할 시 크론탭이 hostname 못 읽을 수 있어 hostname 파일이 있는 절대 경로의 path로 지정해야함

## 왜 모든 변수에 ${} 안 하지?
HOST=${/usr/bin/hostname}
LOG="/tmp/backup.log"
PUSH="/vagrant/SHELL/monitor/bot.sh"
DATE="${/usr/bin/date +%Y.%m.%d}" ## 년.월.일
## 백업할 디렉토리/파일 지정
BAK_LIST="/etc/nginx /usr/share/nginx/html/www"
## 백업 디렉토리
BAK_PATH="/mnt/BACKUP/${HOST}"
## 백업 파일명
BAK_FILE="${BAK_PATH}/${DATE}_${HOST}.tgz"

## 스토리지에 마운트, 필요할 때마다 접속해서 마운트&언마운트 하기
/usr/bin/mount /mnt

## 로그 파일 생성
/usr/bin/touch "${LOG}"

## 백업 디렉토리 확인(없으면 에러 날 수 있으니 에러 예방)
if [ ]
then
	## 백업 디렉토리 존재
	/usr/bin/echo "백업 디렉토리 있습니다. 문제 없음."
else
	/usr/bin/mkdir -p "${BAK_PATH}"
fi



## ****** 로그 기록 시작

## 백업

## ***** 로그 기록 끝

## 스토리지에 언마운트

## 텔레그램으로 백업 로그를 전송
```

- `whitch 명령어`: 명령어가 있는 bin 디렉토리의 절대경로 출력

- `find -name bot.sh`: 파일/디렉토리 찾을 때

- `ps -ef`: 실행 중인 프로세스를 모두 출력

  ```sh
  # ps -ef|grep nginx
  root         629       1  0 Dec02 ?        00:00:00 nginx: master process /usr/sbin/nginx
  nginx        630     629  0 Dec02 ?        00:00:00 nginx: worker process
  nginx        631     629  0 Dec02 ?        00:00:00 nginx: worker process
  root        2412    2376  0 02:34 pts/0    00:00:00 grep --color=auto nginx
  ```

- 백업 디렉토리

  ```sh
  ## nginx 설정 파일
  # cd /ect/nginx/conf.d 
  # cat default.conf
  server {
      listen       80;
      server_name  vws.tmpcompany.com;
  
      access_log  /var/log/nginx/VWS.access.log  main;
  
      location / {
          root   /usr/share/nginx/html/www; ## ✨ 홈페이지를 이루는 소스이자 백업할 파일
          index  index.html index.htm;
      }
  
  }
  ```

- 백업 디렉토리 확인

  - `mkdir -p "${BAK_PATH}"`: 

    백업 디렉토리가 없다면 `BAK_PATH="/mnt/BACKUP/${HOST}"`가 없다는 뜻이므로 /mnt 하위 폴더인 BACKUP이 없는 상태인데

    `mkdir -p` (p: parent) 명령어는  `${HOST}`의 부모 디렉토리인 `/BACKUP` 까지 함께 만들어줘서 에러 방지

    







### 스크립트 작성

- web 서버

- DB 서버

  
