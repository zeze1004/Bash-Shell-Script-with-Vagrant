# 백업 쉘스크립트_디비, 스토리지

- 스토리지는 용량이 너무 커져서 서버 설정 파일만 백업할 것

  

`백업 쉘스크립트_웹`에서 만든 `web_backup.sh`가 있는 `BACKUP` 디렉토리를 스토리지 서버인 `cent3`에 복사할 것

```sh
# scp -rp /vagrant/SHELL/BACKUP cent3:/root/SHELL/BACKUP
## cent3에 SHELL 폴더가 없어서 에러

## cent3에 접속하지 않아도 cent1에서 폴더 만드는 법
# ssh cent3 "mkdir /root/SHELL"

## BACKUP 폴더 복사
# scp -rp /vagrant/SHELL/BACKUP cent3:/root/SHELL/BACKUP
web_backup.sh
```

- `scp`(SecureCoPy):

  SSH 포트인 22번을 통해 네트워크가 연결되어 있는 곳에 암호화로 안전하게 데이터 전송 명령어

  `scp [옵션] [원본서버계정@원본서버IP:복사할데이터경로] [붙여넣을 서버계정@붙여넣을 서버IP:붙여넣을 데이터경로]`

  - 원본서버나 붙여넣을 서버가 로컬일 경우 `계정@IP` 입력 X
  - [더 자세히](./명령어 모음/scp.md)



telegram bot sh도 복사하기

```sh
# scp -rp /vagrant/SHELL/monitor cent3:/root/SHELL/monitor
```



web_backup.sh에서 storage_backup.sh로 변경

```sh
mv web_backup.sh storage_backup.sh

vi strage_backup.sh

## 백업할 디렉토리/파일 지정
BAK_LIST="/etc/exports /etc/nfs.conf /etc/nfsmount.conf"
```

- 백업할 디렉토리/파일 변수 수정
  - `tar`는 묶을 파일들을 공백으로 구분



크론탭에 웹과 마찬가지로 작성

```sh
crontab -e

## 스토리지서버 백업
00 04 * * * /root/SHELL/BACKUP/storage_backup.sh >/dev/null 2>&1
```



# DB 백업 서버

디비 백업은 전체적으로 웹 서버 백업과 동일하나 데이터 덤프하는 부분만 추가하면 됨



cent2(DB 서버)에 폴더를  생성

```
ssh cent2 "mkdir -p /vagrant/SHELL/BACKUP /root/SHELL/monitor"

```

- `mkdir -p`: 부모 디렉토리까지 만들어줌



cent2(db 서버)를 cent1(웹 서버)의 백업 파일을 다른 이름으로 복사

```
# scp /vagrant/SHELL/BACKUP/web_backup.sh cent2:/vagrant/SHELL/BACKUP/db
_backup.sh
web_backup. 100% 2437   408.1KB/s   00:00
```

- `scp`: ssh 포트 20을 통해 암호화하여 네트워크 전송
  - [더 자세한 설명](/명령어 모음/scp.md)

- db_backup.sh의 PATH는 cent3에서 지정한데로 변경

봇 스크립트도 복사하기

```
# scp /vagrant/SHELL/monitor/bot.sh cent2:/vagrant/SHELL/monitor
```



백업 스크립트 수정

`db_backup.sh`

```sh
#!/bin/bash
## 변수 설정, 
## HOST =${hostname}으로 할 시 크론탭이 hostname 못 읽을 수 있어 hostname 파일이 있는 절대 경로의 path로 지정해야함

HOST="$(/usr/bin/hostname)"
LOG="/tmp/backup.log"
PUSH="/vagrant/SHELL/monitor/bot.sh"
DATE="$(/bin/date +%Y.%m.%d)" ## 년.월.일
## 백업할 db 설정 파일
BAK_LIST="/etc/my.cnf.d"
## 백업 디렉토리
BAK_PATH="/mnt/BACKUP/${HOST}"
## 백업 파일명
BAK_FILE="${BAK_PATH}/${DATE}_${HOST}.tgz"

## 디비 백업 디렉토리 --> mariadb 사용시 디폴트로 생성되는 파일
DB_BAK_PATH="/vagrant/SHELL/BACKUP/xtrabackup_backupfiles"

## 디비 백업 파일명
DB_BAK_FILE="${BAK_PATH}/${DATE}_${HOST}_DB.tgz"

## 스토리지에 마운트, 필요할 때마다 접속해서 마운트&언마운트 하기
/usr/bin/mount /mnt

## 로그 파일 생성
/usr/bin/touch "${LOG}"

## 백업 디렉토리 확인 (없으면 에러 날 수 있으니 에러 예방)
if [ -e "${BAK_PATH}" ]
then
	## 백업 디렉토리 존재
	/bin/echo "백업 디렉토리 있습니다. 문제 없음."
else
	## 백업 디렉토리 없으니 생성
	/usr/bin/mkdir -p "${BAK_PATH}"
fi

## ****** 로그 기록 시작 - 중과호 안의 내용이 LOG 파일로 저장
{	
	## 백업 시작 시각
	/bin/echo
	/bin/echo "=== 백업 시작 시각: "
	/bin/date
	/bin/echo
	
    
	## 백업✨✨✨
	## DB dump✨✨✨ <-- 추가된 부분
	/usr/bin/mariabackup \
			--backup \
			--no-lock \
			--target-dir="${DB_BAK_PATH}"
	
	## 백업할 때 변경되는 트랜잭션도 백업 해줘야해서 두 번 백업
	## DB apply logs✨✨✨ <-- 추가된 부분
	/usr/bin/mariabackup \
			--prepare \
			--target-dir="${DB_BAK_PATH}"
	
	/usr/bin/tar czpPf "${BAK_FILE}" ${BAK_LIST}
	
	## 위에서 백업한 DB 디렉토리 압축하기
	/usr/bin/tar czpPf "${DB_BAK_FILE}" ${DB_BAK_PATH}
	
	## 백업 파일 정보
	NAME="$(/usr/bin/ls -al "${BAK_FILE}" | awk '{print $9}')"
	SIZE="$(/usr/bin/ls -al "${BAK_FILE}" | awk '{print $5}')"
	/bin/echo "=== 백업 파일 정보 :"
	/bin/echo " | 파일명: ${NAME}"
	/bin/echo " | 파일크기: ${SIZE}Byte" ## ls로 출력할 때 byte로 뜸
	/bin/echo
	

	
	## DB 백업 파일 정보
	NAME="$(/usr/bin/ls -al "${DB_BAK_FILE}" | awk '{print $9}')"
	SIZE="$(/usr/bin/ls -al "${DB_BAK_FILE}" | awk '{print $5}')"
	/bin/echo "=== DB 백업 파일 정보 :"
	/bin/echo " | 파일명: ${NAME}"
	/bin/echo " | 파일크기: ${SIZE}Byte" ## ls로 출력할 때 byte로 뜸
	/bin/echo
	
	## 백업 종료 시각
	/bin/echo
	/bin/echo "=== 백업 종료 시각: "
	/bin/date
	/bin/echo

} >|"${LOG}"
## ***** 로그 기록 끝

## 스토리지에 언마운트
/usr/bin/umount /mnt

## 텔레그램으로 백업 로그를 전송
"${PUSH}" "${HOST}" "$(/usr/bin/cat "${LOG}")"

## 로그 파일 삭제
/usr/bin/rm -f "${LOG}"
```



디비 연결 오류

```sh
# ./db_backup.sh
백업 디렉토리 있습니다. 문제 없음.
[00] 2021-12-03 23:04:30 Connecting to MySQL server host: localhost, user: not set, password: not set, port: not set, socket: not set
[00] 2021-12-03 23:04:30 Failed to connect to MySQL server: Access denied for user ''@'localhost' (using password: NO).
/usr/bin/mariabackup based on MariaDB server 10.3.28-MariaDB Linux (x86_64)
/usr/bin/mariabackup: Can't change dir to '/vagrant/SHELL/BACKUP/xtrabakup_backupfiles/' (errno: 2 "No such file or directory")
[00] 2021-12-03 23:04:30 can't my_setwd /vagrant/SHELL/BACKUP/xtrabakup_backupfiles/
/usr/bin/tar: Cowardly refusing to create an empty archive
Try '/usr/bin/tar --help' or '/usr/bin/tar --usage' for more information.
/usr/bin/ls: cannot access '/mnt/BACKUP/path/2021.12.03_path_DB.tgz': No such file or directory
/usr/bin/ls: cannot access '/mnt/BACKUP/path/2021.12.03_path_DB.tgz': No such file or directory
```

디비 상태 확인

```sh
# systemctl status mariadb
● mariadb.service - MariaDB 10.3 database server
   Loaded: loaded (/usr/lib/systemd/system/mariadb.service; e>
   Active: active (running)
  
## 실행중인데도 연결x 다시 테스트 db 받기
# git clone https://github.com/t2sc0m/test_db.git ./test_db
# cd test_db
# mysql -uroot < employees.sql

## 테스트용 DB 테이블리스트 확인
# mysql
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 14
Server version: 10.3.28-MariaDB MariaDB Server

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

MariaDB [(none)]> show databases;
+--------------------+
| Database           |
+--------------------+
| employees          |
| information_schema |
| mysql              |
| performance_schema |
+--------------------+
4 rows in set (0.015 sec)

## db process 문제가 아닌 듯 
## mariabackup 실행시 문제가 생기는 듯
# /usr/bin/mariabackup --backup --no-lock --target-dir=/vagrant/SHELL/BACKUP/xtrabackup_backupfiles
[00] 2021-12-03 23:16:59 Connecting to MySQL server host: localhost, user: not set, password: not set, port: not set, socket: not set
[00] 2021-12-03 23:16:59 Failed to connect to MySQL server: Access denied for user ''@'localhost' (using password: NO).

## 유저 옵션 추가
# /usr/bin/mariabackup --backup --no-lock -u root --target-dir=/vagrant/SHELL/BACKUP/xtrabackup_backupfiles
...
[00] 2021-12-03 23:20:05 completed OK!

```

`BACKUP` 디렉토리에 `xtrabackup_backupfiles` 생성 확인

```sh
BACKUP]# ls -alh
total 8.0K
drwxr-xr-x  4 root    root      71 Dec  3 23:19 .
drwxr-xr-x. 4 vagrant vagrant   50 Dec  3 22:03 ..
-rwx------  1 root    root    3.0K Dec  3 22:56 db_backup.sh
drwxr-xr-x  5 root    root    4.0K Dec  3 23:10 test_db
drwx------  5 root    root     241 Dec  3 23:20 xtrabackup_backupfiles ## <----
```

디비 연결은 성공했으나 마운트 실패

```sh
# ./db_backup.sh
백업 디렉토리 있습니다. 문제 없음.
[00] 2021-12-03 23:24:52 Connecting to MySQL server host: localhost, user: not set, password: not set, port: not set, socket: not set
[00] 2021-12-03 23:24:52 Failed to connect to MySQL server: Access denied for user ''@'localhost' (using password: NO).
/usr/bin/mariabackup based on MariaDB server 10.3.28-MariaDB Linux (x86_64)
[00] 2021-12-03 23:24:52 cd to /vagrant/SHELL/BACKUP/xtrabackup_backupfiles/
[00] 2021-12-03 23:24:52 open files limit requested 0, set to 1024
[00] 2021-12-03 23:24:52 This target seems to be not prepared yet.
[00] 2021-12-03 23:24:52 mariabackup: using the following InnoDB configuration for recovery:
[00] 2021-12-03 23:24:52 innodb_data_home_dir = .
[00] 2021-12-03 23:24:52 innodb_data_file_path = ibdata1:12M:autoextend
[00] 2021-12-03 23:24:52 innodb_log_group_home_dir = .
[00] 2021-12-03 23:24:52 InnoDB: Using Linux native AIO
[00] 2021-12-03 23:24:52 Starting InnoDB instance for recovery.
[00] 2021-12-03 23:24:52 mariabackup: Using 104857600 bytes for buffer pool (set by --use-memory parameter)
2021-12-03 23:24:52 0 [Note] InnoDB: Mutexes and rw_locks use GCC atomic builtins
2021-12-03 23:24:52 0 [Note] InnoDB: Uses event mutexes
2021-12-03 23:24:52 0 [Note] InnoDB: Compressed tables use zlib 1.2.11
2021-12-03 23:24:52 0 [Note] InnoDB: Number of pools: 1
2021-12-03 23:24:52 0 [Note] InnoDB: Using SSE2 crc32 instructions
2021-12-03 23:24:52 0 [Note] InnoDB: Initializing buffer pool, total size = 100M, instances = 1, chunk size = 100M
2021-12-03 23:24:52 0 [Note] InnoDB: Completed initialization of buffer pool
2021-12-03 23:24:52 0 [Note] InnoDB: page_cleaner coordinator priority: -20
2021-12-03 23:24:52 0 [Note] InnoDB: Starting crash recovery from checkpoint LSN=1128655330
[00] 2021-12-03 23:24:52 Last binlog file , position 0
[00] 2021-12-03 23:24:53 completed OK!
/usr/bin/tar: Cowardly refusing to create an empty archive
Try '/usr/bin/tar --help' or '/usr/bin/tar --usage' for more information.
/usr/bin/ls: cannot access '/mnt/BACKUP/path/2021.12.03_path_DB.tgz': No such file or directory
/usr/bin/ls: cannot access '/mnt/BACKUP/path/2021.12.03_path_DB.tgz': No such file or directory
```

ㅠㅠ

여전히 `/mnt/BACKUP/path` 디렉토리 못 찾음

```sh
# ls -al /mnt/BACKUP/path/
ls: cannot access '/mnt/BACKUP/path/': No such file or directory
```

근데 또 백업 파일은 압축 됐다고 텔레그램에 뜸...

디비 백업 파일은 뜨지 않음

<p align = "center"><img src="사진 폴더/db_backup_telegram.png"></img></p>

왤까???



### DB 덤프

**dump(이하 덤프)란? [출처](https://heavening.tistory.com/31)
**덤프란 insert into 형식으로 현재 데이터테이블의 구조와 입력된 레코드를 저장하는 방법이다. 이는 백업을 할 때도 사용이 가능하다. text문서이며 query문으로 저장 되기 때문에 일부를 수정 및 추가하여 복구하기 용이하다는 장점이 있다.

- `mysqldump`: 논리적백업
  - 논리적 백업: 테이블 생성, 데이터 쿼리에 대한 SQL 생성문을 갖음
- `mariabackup(XtraBackup)`: 물리적백업
  - 엔진 데이터를 그대로 복사함

#### 논리적 백업과 물리적 백업 차이

[출처1](https://hobogi.tistory.com/entry/MariaDB-Administration-%EB%B0%B1%EC%97%85%EA%B3%BC-%EB%B3%B5%EA%B5%AC-%EA%B0%9C%EC%9A%94)

[출처2](https://techblog.woowahan.com/2576/)

- 논리적 백업
  - 다른 하드웨어나 다른 DBMS, 다른 MariaDB 버전에서도 데이터 복원 가능
  - DB -> 테이블 레벨 순으로 백업 수행
  - 논리적백업은 물리적 백업보다 크기가 크고 백업 / 복원 소요 시간이 더 걸림
  - 로그 파일 / 환경 설정 파일은 논리적 백업의 일부가 아님

- 물리적 백업
  - 다른 하드웨어나 다른 DBMS, 다른 MariaDB 버전에서도 데이터 복원 불가능
  - 디렉토리 -> 파일 레베로 백업 수행

